---
- hosts: local
  #remote_user: root
  #become: yes
  tasks:
  - name: Add an Apt signing key, uses whichever key is at the URL
    ansible.builtin.apt_key:
      url: https://www.mongodb.org/static/pgp/server-4.4.asc
      state: present
  - name: Install gnupg  (state=present is optional)
    apt:
      name: gnupg
      state: present
  - name: Add an Apt signing key, uses whichever key is at the URL
    ansible.builtin.apt_key:
      url: https://www.mongodb.org/static/pgp/server-4.4.asc
      state: present
  - name: Create a list file for MongoDB
    raw: echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.4 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-4.4.list
  - name: Reload local package database
    raw: apt-get update
  - name: Install the MongoDB packages
    apt:
      name: mongodb-org
      state: present
  - name: MongoDB setting
    shell:  "{{ item }}"
    loop:
      - echo "mongodb-org hold" | dpkg --set-selections
      - echo "mongodb-org-server hold" | dpkg --set-selections
      - echo "mongodb-org-shell hold" | dpkg --set-selections
      - echo "mongodb-org-mongos hold" | dpkg --set-selections
      - echo "mongodb-org-tools hold" | dpkg --set-selections
      - ulimit -f unlimited
      - ulimit -t unlimited
      - ulimit -v unlimited
      - ulimit -l unlimited
      - ulimit -n 64000
      - ulimit -m unlimited
        #      - ulimit -u 64000
  - name: Change bindIp to 0.0.0.0 in /etc/mongod.conf
    replace:
      path: /etc/mongod.conf
      regexp: 'bindIp: 127.0.0.1'
      replace: "bindIp: 0.0.0.0"
  - name: Start service mongod, if not started
    ansible.builtin.service:
      name: mongod
      state: started
  - name: Enable service mongod, and not touch the state
    ansible.builtin.service:
      name: mongod
      enabled: yes
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      

      
      
      
      
      
      
      
      
      
      
