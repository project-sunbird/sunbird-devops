- name: Install dependencies for keycloak
  apt:
    name: "{{item}}"
    update_cache: yes
  with_items:
    - python-pip
    - python-setuptools

- name: Copying python libraries
  copy: src={{ role_path }}/files/python-keycloak-0.12.0 dest=/tmp/

- name: Initialize python library to run keycloak paython script
  shell: cd /tmp/python-keycloak-0.12.0 && python setup.py install

- name: Save keycloak vars to json
  template: src="keycloak-bootstrap.conf.j2" dest="/tmp/keycloak-bootstrap.conf.json" mode="0644"

- name: Copy realm json file to tmp location
  template: src="keycloak-realm.j2" dest="/tmp/keycloak-realm.json" mode="0644"

- name: Copy clients file to tmp location
  template: src="clients.j2" dest="/tmp/clients.json" mode="0644"

- name: Copy user manager roles file to tmp location
  copy: src="files/python-keycloak-0.12.0/roles.json" dest="/tmp/roles.json" mode="0644"

- name: Copy the keycloak paython script
  copy:  src={{ role_path }}/files/python-keycloak-0.12.0/keycloak dest=/tmp

- name: Run the keycloak paython script
  shell:  cd /tmp/keycloak/ && python keycloak_patch.py /tmp/keycloak-bootstrap.conf.json
  register: out
  until: '"404" not in out.stderr'
  retries: 2
  delay: 10