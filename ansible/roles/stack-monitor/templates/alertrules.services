ALERT service_down
  IF probe_success == 0
  FOR 5m
  LABELS {
    severity = "FATAL"
  }
  ANNOTATIONS {
      summary = "Service down",
      description = "{% raw %}{{ $labels.job }}{% endraw %}: The service is down.",
  }

ALERT service_flapping
  IF changes(probe_success[10m]) >= 2 && changes(probe_success[10m]) <= 3
  FOR 5m
  LABELS {
    severity = "WARNING"
  }
  ANNOTATIONS {
      summary = "Service flapping",
      description = "The service status has changed {% raw %}{{$value}}{% endraw %} times in last 5 minutes. Threshold is : 3",
  }
  IF changes(probe_success[10m]) > 4
  FOR 5m
  LABELS {
    severity = "CRITICAL"
  }
  ANNOTATIONS {
      summary = "Service flapping",
      description = "The service status has changed {% raw %}{{$value}}{% endraw %} times in last 5 minutes. Threshold is : 4",
  }

ALERT service_replication_failure
  IF ((docker_service_replicas_running / docker_service_replicas_expected) * 100) < 10
  FOR 5m
  LABELS {
    severity = "WARNING"
  }
  ANNOTATIONS {
      summary = "Service replication failed",
      description = "Service replication is {% raw %}{{$value}}{% endraw %}% for {% raw %}{{ $labels.service_name }}{% endraw %}",
  }
  IF ((docker_service_replicas_running / docker_service_replicas_expected) * 100) < 50
  FOR 5m
  LABELS {
    severity = "CRITICAL"
  }
  ANNOTATIONS {
      summary = "Service replication failed",
      description = "Service replication is {% raw %}{{$value}}{% endraw %}% for {% raw %}{{ $labels.service_name }}{% endraw %}",
  }
  IF ((docker_service_replicas_running / docker_service_replicas_expected) * 100) < 70
  FOR 5m
  LABELS {
    severity = "FATAL"
  }
  ANNOTATIONS {
      summary = "Service replication failed",
      description = "Service replication is {% raw %}{{$value}}{% endraw %}% for {% raw %}{{ $labels.service_name }}{% endraw %}",
  }

ALERT too_many_server_side_http_errors
  IF (sum(increase(nginx_request_status_count{status_code=~"5.."}[5m])) / sum(increase(nginx_request_status_count[5m]))) * 100 >= 0.075
  FOR 15m
  LABELS {
    severity = "WARNING"
  }
  ANNOTATIONS {
      summary = "Too many server side http errors",
      description = "Server side http errors: {% raw %}{{$value}}{% endraw %}% has exceeded threshold of 0.075%",
  }
  IF (sum(increase(nginx_request_status_count{status_code=~"5.."}[5m])) / sum(increase(nginx_request_status_count[5m]))) * 100 >= 0.1
  FOR 15m
  LABELS {
    severity = "CRITICAL"
  }
  ANNOTATIONS {
      summary = "Too many server side http errors",
      description = "Server side http errors: {% raw %}{{$value}}{% endraw %}% has exceeded threshold of 0.1%",
  }
  IF (sum(increase(nginx_request_status_count{status_code=~"5.."}[5m])) / sum(increase(nginx_request_status_count[5m]))) * 100 >= 0.5
  FOR 15m
  LABELS {
    severity = "FATAL"
  }
  ANNOTATIONS {
      summary = "Too many server side http errors",
      description = "Server side http errors: {% raw %}{{$value}}{% endraw %}% has exceeded threshold of 0.5%",
  }
