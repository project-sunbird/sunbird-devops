#!/bin/bash
sunbird_custodian_tenant_channel="{{sunbird_custodian_tenant_channel}}"

validateConfigFields() {
        validateField "sunbird_custodian_tenant_channel" "$sunbird_custodian_tenant_channel";
}

validateField() {
        fieldName="$1";
        fieldValue="$2";
        if [ -z "$fieldValue" ];
        then
                echo "Mandatory field - ""$fieldName"" - is not configured. Exiting System Initialisation Program...";
                exit 1;
        fi
}

getExistingCustodianTenantId() {
        sunbird_custodian_tenant_id=$(cqlsh -e "select id from sunbird.organisation where isrootorg=true and channel='""$sunbird_custodian_tenant_channel""' allow filtering;" | awk 'FNR == 4 {print}' | sed 's/ //g')
}

getValueFromSystemSettings() {
        system_settings_id="$1";
        system_settings_value=$(cqlsh -e "select value from sunbird.system_settings where id='""$system_settings_id""';" | awk 'FNR == 4 {print}' | sed 's/ //g')
}

setValueInSystemSettings() {
        system_settings_id="$1";
        system_settings_value="$2";
        cqlsh -e "update sunbird.system_settings set value='""$system_settings_value""',field='""$system_settings_id""' where id='""$system_settings_id""';"
}

validateConfigFields;
getValueFromSystemSettings "systemInitialisationStatus";
if [ -z "$system_settings_value" ];
then
        echo "Adding systemInitialisationStatus field to System Settings table...";
        setValueInSystemSettings "systemInitialisationStatus" "SYSTEM_UNINITIALISED";
fi

getValueFromSystemSettings "systemInitialisationStatus";
if [ -z "$system_settings_value" ];
then
        echo "Unable to connect to Cassandra. Exiting program...";
        exit 1;
fi
if [ "$system_settings_value" = "SYSTEM_INITIALISED" ];
then
        echo "System already Initialised. Exiting program...";
        exit 0;
fi

getExistingCustodianTenantId;
if [ -z "$sunbird_custodian_tenant_id" ];
then
        echo "No Root Organisation found for the configured channel - ""$sunbird_custodian_tenant_channel"" . Exiting System Initialisation Program...";
        exit 1;
else
        echo "Root Organisation with id - ""$sunbird_custodian_tenant_id"" - found for the configured channel - ""$sunbird_custodian_tenant_channel";
        setValueInSystemSettings "custodianOrgId" "$sunbird_custodian_tenant_id";
        setValueInSystemSettings "custodianOrgChannel" "$sunbird_custodian_tenant_channel";
        setValueInSystemSettings "systemInitialisationStatus" "SYSTEM_INITIALISED";
        echo "System Initialisation Completed Successfully..."
fi