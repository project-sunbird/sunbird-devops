---

- name: Update node exporter ip
  replace:
    path: /opt/docker/stacks/monitor/config/prometheus.yml
    regexp: ':9091]$'
    replace: ":9091{% for ip in groups['all'] %}','{{ ip }}:9091{% endfor %}']"


- name: Update process exporter ip
  replace:
    path: /opt/docker/stacks/monitor/config/prometheus.yml
    regexp: ':1111]$'
    replace: ":1111{% for ip in groups['process-exporter'] %}','{{ ip }}:1111{% endfor %}']"


- name: Remove docker config
  shell: "docker config rm prometheus.yml"

- name: Create docker config
  shell: "docker config create /opt/docker/stacks/monitor/config/prometheus.yml prometheus.yml"

- name: Deploy monitoring
  shell: "docker stack deploy -c /opt/docker/stacks/monitor/stack/monitor.yml monitor"
