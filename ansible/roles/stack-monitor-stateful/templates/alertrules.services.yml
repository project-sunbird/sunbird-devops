groups:
- name: alertrules.services
  rules:
  - alert: service_down
    expr: probe_success == 0
    for: 5m
    annotations:
      description: '{% raw %}{{ $labels.job }}{% endraw %}: The service is down.'
      summary: Service down
  - alert: service_flapping
    expr: changes(probe_success[10m]) > 3
    for: 5m
    annotations:
      description: 'The service status has changed {% raw %}{{$value}}{% endraw %} times in last 5 minutes. Threshold is : 3'
      summary: Service flapping
  - alert: service_replication_failure
    expr: ((docker_service_replicas_running / docker_service_replicas_expected) * 100) < 100
    for: 5m
    annotations:
      description: Service replication is {% raw %}{{$value}}{% endraw %}% for {% raw %}{{ $labels.service_name }}{% endraw %}
      # Empty line for jinja template formating
      summary: Service replication failed
  - alert: too_many_server_side_http_errors
    expr: (sum(increase(nginx_request_status_count{status_code=~"5.."}[5m])) / sum(increase(nginx_request_status_count[5m]))) * 100 > {{ server_side_http_errors_threshold_percentage }}
    for: 15m
    annotations:
      description: 'Server side http errors: {% raw %}{{$value}}{% endraw %}% has exceeded threshold of {{ server_side_http_errors_threshold_percentage }}%'
      summary: Too many server side http errors
