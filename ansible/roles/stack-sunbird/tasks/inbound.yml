---
- name: Remove uci-inbound
  shell: "docker service rm uci-inbound"
  ignore_errors: yes

- name: Save configurations into an env file
  become: yes
  template: src=inbound.env dest=/home/deployer/config/uci-inbound.env mode=0644

- name: Remove old docker config
  become: yes
  shell: "docker config rm uci-inbound.env"
  ignore_errors: yes

- name: Save as docker config
  become: yes
  shell: "docker config create uci-inbound.env /home/deployer/config/uci-inbound.env"

- name: Deploy uci-inbound
  shell: "docker service create --with-registry-auth --replicas {{ uci_inbound_replicas }} -p 8085:8085  --name uci-inbound --hostname uci-inbound --reserve-memory {{ uci_inbound_reservation_memory }} --limit-memory {{ uci_inbound_limit_memory }} --limit-cpu {{ uci_inbound_limit_cpu }} --reserve-cpu {{ uci_inbound_reservation_cpu }} --health-cmd 'wget -qO- uci-inbound:8085/health || exit 1' --health-timeout 10s --health-retries 5  --network application_default --env JAVA_OPTIONS={{ uci_inbound_java_mem_limit }} --config source=uci-inbound.env,target=/home/sunbird/inbound/config/application.properties,mode=0644 {{hub_org}}/{{image_name}}:{{image_tag}}"
  args:
    chdir: /home/deployer/stack
