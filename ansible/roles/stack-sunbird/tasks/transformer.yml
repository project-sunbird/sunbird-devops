---
- name: Remove uci-transformer
  shell: "docker service rm uci-transformer"
  ignore_errors: yes

- name: Save configurations into an env file
  become: yes
  template: src=transformer.env dest=/home/deployer/config/uci-transformer.env mode=0644

- name: Remove old docker config
  become: yes
  shell: "docker config rm uci-transformer.env"
  ignore_errors: yes

- name: Save as docker config
  become: yes
  shell: "docker config create uci-transformer.env /home/deployer/config/uci-transformer.env"

- name: Save xml configuration into a env file
  become: yes
  template: src=transformer_industry_feedback.xml dest=/home/deployer/config/transformer_industry_feedback.xml mode=0644

- name: Remove old xml docker config
  become: yes
  shell: "docker config rm transformer_industry_feedback.xml"
  ignore_errors: yes

- name: Copy new xml
  become: yes
  shell: "docker config create transformer_industry_feedback.xml /home/deployer/config/transformer_industry_feedback.xml"

- name: Deploy uci-transformer
  shell: "docker service create --with-registry-auth --replicas {{ uci_transformer_replicas }} -p 8080:8080  --name uci-transformer --hostname uci-transformer --reserve-memory {{ uci_transformer_reservation_memory }} --limit-memory {{ uci_transformer_limit_memory }} --limit-cpu {{ uci_transformer_limit_cpu }} --reserve-cpu {{ uci_transformer_reservation_cpu }} --health-cmd 'wget -qO- uci-transformer:8080/health || exit 1' --health-timeout 10s --health-retries 5  --network application_default --env JAVA_OPTIONS={{ uci_transformer_java_mem_limit }} --config source=uci-transformer.env,target=/home/sunbird/transformer/config/application-messagerosa.properties,mode=0644 --config source=transformer_industry_feedback.xml,target=/home/sunbird/transformer/config/Industry_feedback.xml,mode=0644 {{hub_org}}/{{image_name}}:{{image_tag}}"
  args:
    chdir: /home/deployer/stack