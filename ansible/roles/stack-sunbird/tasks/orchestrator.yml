---
- name: Remove uci-orchestrator
  shell: "docker service rm uci-orchestrator"
  ignore_errors: yes

- name: Save configurations into an env file
  become: yes
  template: src=orchestrator.env dest=/home/deployer/config/uci-orchestrator.env mode=0644

- name: Remove old docker config
  become: yes
  shell: "docker config rm uci-orchestrator.env"
  ignore_errors: yes

- name: Save as docker config
  become: yes
  shell: "docker config create uci-orchestrator.env /home/deployer/config/uci-orchestrator.env"

- name: Save excel configuration into a env file
  become: yes
  template: src=orchestrator_rules.xlsx dest=/home/deployer/config/orchestrator_rules.xlsx mode=0644

- name: Remove old excel docker config
  become: yes
  shell: "docker config rm orchestrator_rules.xlsx"
  ignore_errors: yes

- name: Copy new excel
  become: yes
  shell: "docker config create orchestrator_rules.xlsx /home/deployer/config/orchestrator_rules.xlsx"

- name: Deploy uci-orchestrator
  shell: "docker service create --with-registry-auth --replicas {{ uci_orchestrator_replicas }} -p 8686:8686  --name uci-orchestrator --hostname uci-orchestrator --reserve-memory {{ uci_orchestrator_reservation_memory }} --limit-memory {{ uci_orchestrator_limit_memory }} --limit-cpu {{ uci_orchestrator_limit_cpu }} --reserve-cpu {{ uci_orchestrator_reservation_cpu }} --health-cmd 'wget -qO- uci-orchestrator:8686/health || exit 1' --health-timeout 10s --health-retries 5  --network application_default --env JAVA_OPTIONS={{ uci_orchestrator_java_mem_limit }} --config source=uci-orchestrator.env,target=/home/sunbird/orchestrator/config/application.properties,mode=0644 --config source=orchestrator_rules.xlsx,target=/home/sunbird/orchestrator/config/logback-spring.xml,mode=0644 {{hub_org}}/{{image_name}}:{{image_tag}}"
  args:
    chdir: /home/deployer/stack 