---
- name: Remove stack file 
  shell: rm -rf /home/deployer/stack/stack_{{service_name}}.yml
  ignore_errors: yes

- name: Save stack file
  template: src="stack_{{service_name}}.yml" dest="/home/deployer/stack/stack_{{service_name}}.yml" mode=0644

- name: Save config file
  copy: src="{{cdn_file_path}}" dest="/home/deployer/config/index_cdn.ejs" mode=0644
  when: sunbird_portal_cdn_url is not none  # Checking if variable is empty or not
  register: indexFileChange

- debug:
    msg: "{{indexFileChange}}"

- name: Deploy stack
  shell: "docker stack deploy -c stack_{{service_name}}.yml {{service_name}} --with-registry-auth"
  args:
    chdir: /home/deployer/stack
  register: stackDeployed

- name: check if player is running
  shell: docker service ps player_player
  become: yes
  register: playerRunning
  ignore_errors: yes

- name: Remove the cdn file from  player if it's present
  shell: docker service update --config-rm index_cdn.ejs player_player
  when: indexFileChange.changed and playerRunning.rc == 0 and sunbird_portal_cdn_url is not none

- name: Remove the existing config if it is present
  shell: docker config rm index_cdn.ejs
  when: indexFileChange.changed and playerRunning.rc == 0 and sunbird_portal_cdn_url is not none
  ignore_errors: yes

- name: Create the index_cdn.ejs file as a config
  shell: "docker config create index_cdn.ejs /home/deployer/config/index_cdn.ejs"
  ignore_errors: yes

- name: Deploy Player with updated player config
  shell: docker service update --config-add source=index_cdn.ejs,target=/home/sunbird/app_dist/dist/index_cdn.ejs player_player
  when: sunbird_portal_cdn_url is not none and indexFileChange.changed and playerRunning.rc == 0
  ignore_errors: yes

- name: Deploy stack
  shell: "docker stack deploy -c stack_{{service_name}}.yml {{service_name}} --with-registry-auth"
  args:
    chdir: /home/deployer/stack
  register: stackDeployed

- name: Inject config file for the first player deploy
  shell: docker service update --config-add source=index_cdn.ejs,target=/home/sunbird/app_dist/dist/index_cdn.ejs player_player
  when: playerRunning.rc != 0
