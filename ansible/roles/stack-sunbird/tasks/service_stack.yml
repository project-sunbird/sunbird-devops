---
- name: Save stack file
  template: src="stack_{{service_name}}.yml" dest="/home/deployer/stack/stack_{{service_name}}.yml" mode=0644

- name: Save config file
  copy: src="{{cdn_file_path}}" dest="/home/deployer/config/index_cdn.ejs" mode=0644
  when: sunbird_portal_cdn_url is defined
  register: copy_file
  ignore_errors: yes

- debug:
    msg: "{{copy_file}}"

- name: check if player is running
  shell: docker service ps player_player
  become: yes
  register: playerRunning
  ignore_errors: yes

- name: Remove the cdn file from  player if it's present
  shell: docker service update --config-rm index_cdn.ejs player_player
  when: copy_file.changed and playerRunning.changed and sunbird_portal_cdn_url is defined

- name: Remove the existing config if it is present
  shell: docker config rm index_cdn.ejs
  when: copy_file.changed and playerRunning.changed and sunbird_portal_cdn_url is defined

- name: Create the index_cdn.ejs file as a config
  shell: "docker config create index_cdn.ejs /home/deployer/config/index_cdn.ejs"
  when: sunbird_portal_cdn_url is defined and copy_file.changed and sunbird_portal_cdn_url is defined

- name: Deploy Player with updated player config
  shell: docker service update --config-add source=index_cdn.ejs,target=/home/sunbird/app_dist/dist/index_cdn.ejs player_player
  when: sunbird_portal_cdn_url is defined and copy_file.changed and sunbird_portal_cdn_url is defined

- name: Deploy stack
  shell: "docker stack deploy -c stack_{{service_name}}.yml {{service_name}} --with-registry-auth"
  args:
    chdir: /home/deployer/stack
  when: not playerRunning.changed
  register: stackDeployed

- name: Inject config file for the first player deploy
  shell: docker service update --config-add source=index_cdn.ejs,target=/home/sunbird/app_dist/dist/index_cdn.ejs player_player
  when: stackDeployed.changed
