---
- hosts: local
  vars_files:
    - "{{ inventory_dir }}/secrets.yml"
  tasks:
    - name: taking backup of keycloak db
      postgresql_db:
        name: "{{ keycloak_postgres_database }}"
        state: dump
        target: keycloak.sql
        login_user: "{{keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
        port: 5432
    - name: restoring keycloak old db to new db named  "{{ keycloak_postgres_database }}_601"
      postgresql_db:
        name: "{{ keycloak_postgres_database }}_601"
        state: restore
        target: keycloak.sql
        login_user: "{{ keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
        port: 5432
    - name: Stopping keycloak
      shell: /etc/init.d/keycloak stop || pkill keycloak
    - name: Backing up old keycloak
      copy:
        dest: /opt/keycloak_bak
        src: /opt/keycloak
        force: yes
        remote_src: yes
        follow: no
        local_follow: yes
