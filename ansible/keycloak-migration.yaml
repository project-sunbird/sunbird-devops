---
- hosts: local
  vars_files:
    - "{{ inventory_dir }}/secrets.yml"
  tasks:
    - name: taking backup of keycloak db
      become: yes
      postgresql_db:
        name: "{{ keycloak_postgres_database }}"
        state: dump
        target: /root/keycloak.sql
        login_user: "{{keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
        port: 5432
    - name: creating newdb  "{{ keycloak_postgres_database }}_601"
      postgresql_db:
        name: "{{ keycloak_postgres_database }}_601"
        state: present
        login_user: "{{ keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
    - name: restoring keycloak old db to new db named  "{{ keycloak_postgres_database }}_601"
      become: yes
      postgresql_db:
        name: "{{ keycloak_postgres_database }}_601"
        state: restore
        target: /root/keycloak.sql
        login_user: "{{ keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
        port: 5432
- hosts: keycloak
  become: yes
  become_user: keycloak
  vars:
    keycloak_dir: /opt/keycloak
  vars_files:
    - "{{ inventory_dir }}/secrets.yml"
  tasks:
    # - name: Stopping keycloak
    #   shell: /etc/init.d/keycloak stop || pkill keycloak
    - name: Backing up old keycloak
      become: yes
      shell: "cp -rf {{ keycloak_dir }} {{ keycloak_dir }}_old && chown -R keycloak:keycloak {{ keycloak_dir }}_old"
    - name: make sure keycloak path exists
      become: yes
      file:
        path: "{{ keycloak_dir }}_new"
        state: directory
        owner: keycloak
        group: keycloak
    - name: downloading and unarchiving new keycloak 6.0.1
      unarchive:
        src: https://sunbirdpublic.blob.core.windows.net/installation/keycloak-6.0.1.tar.gz
        dest: "{{ keycloak_dir }}_new"
        remote_src: yes
        owner: keycloak
        group: keycloak
    # - name: copying old modules to new keycloak
    #   copy:
    #     dest: "{{ item }}"
    #     src: "{{ item }}"
    #     force: yes
    #     directory_mode: yes
    #     remote_src: yes
    #     follow: no
    #     local_follow: yes
    #     owner: keycloak
    #     group: keycloak
