---
- hosts: local
  vars_files:
    - "{{ inventory_dir }}/secrets.yml"
  vars:
    db_backup_name: "/root/keycloak{{ ansible_date_time.epoch }}.sql"
  tasks:
    - name: taking backup of keycloak db
      become: yes
      postgresql_db:
        name: "{{ keycloak_postgres_database }}"
        state: dump
        target: "{{ db_backup_name }}"
        login_user: "{{keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
        port: 5432
    - name: creating backup db {{ keycloak_postgres_database }}_301
      postgresql_db:
        name: "{{ keycloak_postgres_database }}_301"
        state: present
        login_user: "{{ keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
      register: status
    - name: debugging
      debug:
        var: status
    - name: creating backup keycloak old db {{ keycloak_postgres_database }}_301 for the first time
      become: yes
      postgresql_db:
        name: "{{ keycloak_postgres_database }}_301"
        state: restore
        target: "{{ db_backup_name }}"
        login_user: "{{ keycloak_postgres_user }}"
        login_password: "{{ keycloak_postgres_password }}"
        login_host: "{{ keycloak_postgres_host }}"
        port: 5432
      when: status.changed
- hosts: keycloak
  vars:
    keycloak_dir: /opt/keycloak
  vars_files:
    - "{{ inventory_dir }}/secrets.yml"
  tasks:
    - name: Stopping keycloak
      become: yes
      shell: /bin/bash -c "/etc/init.d/keycloak stop || pkill keycloak"
    - name: Backing up old keycloak
      become: yes
      shell: "cp -rf {{ keycloak_dir }} {{ keycloak_dir }}_old && chown -R keycloak:keycloak {{ keycloak_dir }}_old"
    - name: make sure keycloak path exists
      become: yes
      file:
        path: "{{ keycloak_dir }}_new"
        state: directory
        owner: keycloak
        group: keycloak
    - name: copy and unarchiving new keycloak 6.0.1
      become: yes
      unarchive:
        src: "{{keycoak_zip}}"
        dest: "{{ keycloak_dir }}_new"
        owner: keycloak
        group: keycloak
        extra_opts: [--strip-components=1]
    - name: Copying old files to new keycloak for migration
      become: yes
      become_user: keycloak
      shell: "cp -rf {{ keycloak_dir }}_old/{{ item }}/* {{ keycloak_dir }}_new/{{ item }}/ "
      with_items:
        - standalone
        - domain
    - name: Running migration
      become: yes
      become_user: keycloak
      shell: "bash {{ item }}"
      with_items:
        - "bin/jboss-cli.sh --file=bin/migrate-standalone.cli"
        - "bin/jboss-cli.sh --file=bin/migrate-standalone-ha.cli"
      args:
        chdir: "{{ keycloak_dir }}_new"
