- hosts: local
  become: yes
  gather_facts: no
  vars_files:
    - "{{inventory_dir}}/secrets.yml"
  environment:
        AZURE_STORAGE_ACCOUNT: "{{ azure_plugin_storage_account_name }}"
        AZURE_STORAGE_KEY: "{{ azure_plugin_storage_account_key }}"
  tasks:
    - name: rename env_domain in preview_cdn.html for CDN
      shell: |
        #domain_name=$(grep sunbird_portal_player_cdn_url "{{inventory_dir}}"/common.yml | cut -d' ' -f2 | tr -d "\"" | cut -d"/" -f3)
        #domain_name=$(grep sunbird_portal_content_cdn_url "{{inventory_dir}}"/common.yml | cut -d' ' -f2 | tr -d "\"")
        #echo "$domain_name"
        echo "{{sunbird_portal_content_cdn_url}}"
        sed -i 's|cdn_url|{{sunbird_portal_content_cdn_url}}|g' "{{currentws}}"/ansible/preview/preview_cdn.html
      when: sunbird_portal_content_cdn_url is defined
      tags:
        - preview

    - name: delete batch
      command: "az storage blob delete-batch -s {{ plugin_container_name }} --pattern {{ folder_name }}/*"
      async: 3600
      poll: 10
      tags:
        - content-editor 
        - collection-editor
        - generic-editor
        - preview

    - name: upload batch
      command: "az storage blob upload-batch --destination {{ plugin_container_name }}/{{ folder_name }} --source {{ source_name }}"
      async: 3600
      poll: 10
      tags:
        - content-editor 
        - collection-editor
        - generic-editor
        - preview
        - editor
        - core-plugins
  
    - name: rename env_domain in preview_cdn.html for CDN
      shell: |
        #domain_name=$(grep sunbird_portal_player_cdn_url "{{inventory_dir}}"/common.yml | cut -d' ' -f2 | tr -d "\"" | cut -d"/" -f3)
        #domain_name=$(grep sunbird_portal_content_cdn_url "{{inventory_dir}}"/common.yml | cut -d' ' -f2 | tr -d "\"")
        #echo "$domain_name"
        echo "{{sunbird_portal_content_cdn_url}}"
        sed -i 's|cdn_url|{{sunbird_portal_content_cdn_url}}|g' "{{currentws}}"/ansible/preview/preview_cdn.html
      when: sunbird_portal_content_cdn_url is defined  
      tags:
        - preview
        
#    - name: cdn delete batch
#      command: "az storage blob delete-batch -s {{ cdn_container_name }} --pattern {{ cdn_folder_name }}/*"
#      async: 3600
#      poll: 10
#      when: sunbird_portal_content_cdn_url is defined
#      tags:
#        - preview
#
#    - name: cdn upload batch
#      command: "az storage blob upload-batch --destination {{ cdn_container_name }}/{{ cdn_folder_name }} --source {{ source_name }}"
#      async: 3600
#      poll: 10
#      when: sunbird_portal_content_cdn_url is defined
#      tags:
#        - preview

    - name: upload file
      command: "az storage blob upload --container-name {{ plugin_container_name }} --file {{ source_file_name }} --name artefacts/content-player/content-player-{{ player_version_number }}.zip"
      async: 3600
      poll: 10  
      tags:
        - preview

    - name:  run az_copy.sh
      shell: "bash {{ az_file_path }} {{ plugin_container_name }} {{ source_file }}"
      async: 3600
      poll: 10
      tags:
        - plugins
