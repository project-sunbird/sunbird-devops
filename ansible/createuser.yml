---
- hosts: "{{ remote }}"
  gather_facts: false
  become: yes
  vars_files:
    - ['{{inventory_dir}}/secrets.yml', 'secrets/{{env}}.yml']
  roles:
    - createuser
  tags:
    - add-user

- hosts: "swarm-nodes"
  gather_facts: false
  become: yes
  vars_files:
    - ['{{inventory_dir}}/secrets.yml', 'secrets/{{env}}.yml']
  tasks:
    - shell: "usermod -aG docker {{ user }}"
      ignore_errors: true
  tags:
    - add-user

- hosts: "{{remote}}"
  gather_facts: false
  become: yes
  become_user: "{{ user }}"
  vars_files:
    - ['{{inventory_dir}}/secrets.yml', 'secrets/{{env}}.yml']
  tasks:
    - shell: "{{ command }}"
      ignore_errors: true
  tags:
    - add-user

- hosts: "{{ remote }}"
  gather_facts: false
  become: yes
  vars_files:
    - ['{{inventory_dir}}/secrets.yml', 'secrets/{{env}}.yml']
  tasks:
    - user: name="{{ user }}" state=absent remove=yes
  tags:
    - delete-user
