---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    role: alert-rules
    app: {{ .Values.serviceMonitorLabels.release }}
    release: {{ .Values.serviceMonitorLabels.release }}
  name: {{ include "kafka-topic-exporter.fullname" . }}-alertrule
  namespace: {{ default .Values.namespace .Release.Namespace  }}
spec:
  groups:
  - name: alertrules.kafkalag
    rules:
    - alert: AssessmentAggregator lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "AssessmentAggregator"}) > {{ .Values.assessment_aggregator_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"AssessmentAggregator lag is {{$value}}"`
        summary: AssessmentAggregator lag is Critical

    - alert: DeDuplication lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "DeDuplication"}) > {{ .Values.deduplication_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"DeDuplication lag is {{$value}}"`
        summary: DeDuplication lag is Critical

    - alert: DeNormalization lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "DeNormalization"}) > {{ .Values.denormalization_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"DeNormalization lag is {{$value}}"`
        summary: DeNormalization lag is Critical

    - alert: DerivedDeDuplication lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "DerivedDeDuplication"}) > {{ .Values.derived_deduplication_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"DerivedDeDuplication lag is {{$value}}"`
        summary: DerivedDeDuplication lag is Critical

    - alert: DeviceProfileUpdater lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "DeviceProfileUpdater"}) > {{ .Values.device_profileupdater_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"DeviceProfileUpdater lag is {{$value}}"`
        summary: DeviceProfileUpdater lag is Critical

    - alert: DruidEventsValidator lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "DruidEventsValidator"}) > {{ .Values.druidevents_validator_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"DruidEventsValidator lag is {{$value}}"`
        summary: DruidEventsValidator lag is Critical

    - alert: EventsRouter lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "EventsRouter"}) > {{ .Values.events_router_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"EventsRouter lag is {{$value}}"`
        summary: EventsRouter lag is Critical

    - alert: TelemetryExtractor lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "TelemetryExtractor"}) > {{ .Values.telemetry_extractor_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"TelemetryExtractor lag is {{$value}}"`
        summary: TelemetryExtractor lag is Critical

    - alert: TelemetryLocationUpdater lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "TelemetryLocationUpdater"}) > {{ .Values.telemetry_location_updater_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"TelemetryLocationUpdater lag is {{$value}}"`
        summary: TelemetryLocationUpdater lag is Critical

    - alert: TelemetryRedacter lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "TelemetryRedacter"}) > {{ .Values.telemetry_redacter_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"TelemetryRedacter lag is {{$value}}"`
        summary: TelemetryRedacter lag is Critical

    - alert: TelemetryRouter lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "TelemetryRouter"}) > {{ .Values.telemetry_router_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"TelemetryRouter lag is {{$value}}"`
        summary: TelemetryRouter lag is Critical

    - alert: TelemetryValidator lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "TelemetryValidator"}) > {{ .Values.telemetry_validator_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"TelemetryValidator lag is {{$value}}"`
        summary: TelemetryValidator lag is Critical

    - alert: UserCacheUpdater lag
      expr: sum(samza_pipeline_metrics_consumer_lag{job_name= "UserCacheUpdater"}) > {{ .Values.user_cacheupdater_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: `"UserCacheUpdater lag is {{$value}}"`
        summary: UserCacheUpdater lag is Critical
