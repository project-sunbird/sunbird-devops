---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    role: alert-rules
    app: {{ .Values.prometheus_rule_selector_app }}
    release: {{ .Values.prometheus_rule_selector_release }}
  name: {{ .Values.fullnameOverride }}-kafkalag-rules
  namespace: {{ .Values.namespace }}
spec:
  groups:
  - name: alertrules.kafkalag
    rules:
    - alert: secor {{ .Values.kafka_topic_prefix }}.telemetry.assess.raw group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.telemetry.assess.raw", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_assess_raw_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.telemetry.assess.raw consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.telemetry.assess.raw
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.telemetry.denorm.backup group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.telemetry.denorm.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_denorm_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.telemetry.denorm.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.telemetry.denorm.backup
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.telemetry.derived.unique.backup consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.telemetry.derived.unique.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_derived_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.telemetry.derived.unique.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.telemetry.derived.unique.backup
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.druid.events.summary consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.druid.events.summary", job="processing-kafka-exporter"} > {{ .Values.kafka_druid_events_summary_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.druid.events.summary consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.druid.events.summary
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.extractor.duplicate.backup consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.extractor.duplicate.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_extractor_duplicate_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.extractor.duplicate.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.extractor.duplicate.backup
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.extractor.failed.backup consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.extractor.failed.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_extractor_failed_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.extractor.failed.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.extractor.failed.backup
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.telemetry.failed.backup consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.telemetry.failed.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_failed_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.telemetry.failed.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.telemetry.failed.backup
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.telemetry.raw.backup consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.telemetry.raw.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_raw_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.telemetry.raw.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.telemetry.raw.backup
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.telemetry.duplicate.backup consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.telemetry.duplicate.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_duplicate_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.telemetry.duplicate.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.telemetry.duplicate.backup
    
    - alert: secor {{ .Values.kafka_topic_prefix }}.telemetry.unique.backup consumer group lag
      expr: kafka_consumergroupzookeeper_lag_zookeeper{consumergroup="{{ .Values.kafka_topic_prefix }}.telemetry.unique.backup", job="processing-kafka-exporter"} > {{ .Values.kafka_telemetry_unique_backup_threshold }}
      for: 5m
      labels:
        severity: critical
      annotations:
        message: {{`"`}}{{ .Values.kafka_topic_prefix }}{{`.telemetry.unique.backup consumer group lag is {{$value}} for partition: {{ $labels.partition }}"`}}
        summary: secor consumer group lag is more for {{ .Values.kafka_topic_prefix }}.telemetry.unique.backup
