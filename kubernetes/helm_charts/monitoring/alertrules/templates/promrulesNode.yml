---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    role: alert-rules
    app: {{ .Values.prometheus_rule_selector_app }}
    release: {{ .Values.prometheus_rule_selector_release }}
  name: {{ .Values.fullnameOverride }}-node-rules
  namespace: {{ .Values.namespace }}
spec:
  groups:
  - name: alertrules.nodes
    rules:
    - alert: high_cpu_usage_on_node_WARNING
      expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job="node-exporter",mode="idle"}[5m])) * 100) >= {{ .Values.node_cpu_usage_percentage_threshold_Warning }} and (avg by (instance) (irate(node_cpu_seconds_total{job="node-exporter",mode="idle"}[5m])) * 100) < {{ .Values.node_cpu_usage_percentage_threshold_Critical }}
      for: 1m
      labels:
        severity: WARNING
      annotations:
        description: {{`'{{ $labels.instance }} is using a LOT of CPU. CPU usage is {{ humanize $value}}%.'`}}
        summary: {{`'HIGH CPU USAGE WARNING ON {{ $labels.instance }}'`}}
    - alert: high_cpu_usage_on_node_CRITICAL
      expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job="node-exporter",mode="idle"}[5m])) * 100) >= {{ .Values.node_cpu_usage_percentage_threshold_Critical }} and (avg by (instance) (irate(node_cpu_seconds_total{job="node-exporter",mode="idle"}[5m])) * 100) < {{ .Values.node_cpu_usage_percentage_threshold_Fatal }}
      for: 1m
      labels:
        severity: CRITICAL
      annotations:
        description: {{`'{{ $labels.instance }} is using a LOT of CPU. CPU usage is {{ humanize $value}}%.'`}}
        summary: {{`'HIGH CPU USAGE WARNING ON {{ $labels.instance }}'`}}
    - alert: high_cpu_usage_on_node_FATAL
      expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job="node-exporter",mode="idle"}[5m])) * 100) >= {{ .Values.node_cpu_usage_percentage_threshold_Fatal }}
      for: 1m
      labels:
        severity: FATAL
      annotations:
        description: {{`'{{ $labels.instance }} is using a LOT of CPU. CPU usage is {{ humanize $value}}%.'`}}
        summary: {{`'HIGH CPU USAGE WARNING ON {{ $labels.instance }}'`}}
    - alert: high_memory_usage_on_node_WARNING
      expr: sum by(nodename) ((((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * on(instance) group_left(nodename) node_uname_info * 100) >= {{ .Values.node_memory_usage_percentage_threshold_Warning }} and (((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * on(instance) group_left(nodename) node_uname_info * 100) < {{ .Values.node_memory_usage_percentage_threshold_Critical }} )
      for: 1m
      labels:
        severity: WARNING
      annotations:
        description: {{`'{{ $labels.nodename }} ({{ $labels.host }}) is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'`}}
        summary: {{`'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.nodename }}'`}}
    - alert: high_memory_usage_on_node_CRITICAL
      expr: sum by(nodename) ((((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * on(instance) group_left(nodename) node_uname_info * 100) >= {{ .Values.node_memory_usage_percentage_threshold_Critical }} and (((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * on(instance) group_left(nodename) node_uname_info * 100) < {{ .Values.node_memory_usage_percentage_threshold_Fatal }} )
      for: 1m
      labels:
        severity: CRITICAL
      annotations:
        description: {{`'{{ $labels.nodename }} ({{ $labels.host }}) is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'`}}
        summary: {{`'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.nodename }}'`}}
    - alert: high_memory_usage_on_node_FATAL
      expr: sum by(nodename) (((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * on(instance) group_left(nodename) node_uname_info * 100) >= {{ .Values.node_memory_usage_percentage_threshold_Fatal }}
      for: 1m
      labels:
        severity: FATAL
      annotations:
        description: {{`'{{ $labels.nodename }} ({{ $labels.host }}) is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'`}}
        summary: {{`'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.nodename }}'`}}
    - alert: high_load_on_node_WARNING
      expr: sum by(nodename) (((node_load1 / count without(cpu, mode) (node_cpu_seconds_total{mode="system"}))* on(instance) group_left(nodename) node_uname_info * 100) >= {{ .Values.node_load_avg_threshold_Warning }} and ((node_load1 / count without(cpu, mode) (node_cpu_seconds_total{mode="system"}))* on(instance) group_left(nodename) node_uname_info * 100) < {{ .Values.node_load_avg_threshold_Critical }} )
      for: 5m
      labels:
        severity: WARNING
      annotations:
        description: {{`'{{ $labels.nodename }} ({{ $labels.host }}) has a high load average. Load average is {{ $value }}%.'`}}
        summary: {{`'HIGH LOAD AVERAGE WARNING ON {{ $labels.nodename }}'`}}
    - alert: high_load_on_node_CRITICAL
      expr: sum by(nodename) (((node_load1 / count without(cpu, mode) (node_cpu_seconds_total{mode="system"}))* on(instance) group_left(nodename) node_uname_info * 100) >= {{ .Values.node_load_avg_threshold_Warning }} and ((node_load1 / count without(cpu, mode) (node_cpu_seconds_total{mode="system"}))* on(instance) group_left(nodename) node_uname_info * 100) < {{ .Values.node_load_avg_threshold_Critical }} )
      for: 5m
      labels:
        severity: CRITICAL
      annotations:
        description: {{`'{{ $labels.nodename }} ({{ $labels.host }}) has a high load average. Load average is {{ $value }}%.'`}}
        summary: {{`'HIGH LOAD AVERAGE WARNING ON {{ $labels.nodename }}'`}}
    - alert: high_load_on_node_FATAL
      expr: sum by(nodename) ((node_load1 / count without(cpu, mode) (node_cpu_seconds_total{mode="system"}))* on(instance) group_left(nodename) node_uname_info * 100) > {{ .Values.node_load_avg_threshold_Fatal }}
      for: 5m
      labels:
        severity: FATAL
      annotations:
        description: {{`'{{ $labels.nodename }} ({{ $labels.host }}) has a high load average. Load average is {{ $value }}%.'`}}
        summary: {{`'HIGH LOAD AVERAGE WARNING ON {{ $labels.nodename }}'`}}
    - alert: node_exporter_down_CRITICAL
      expr: up == 0
      for: 1m
      labels:
        severity: CRITICAL
      annotations:
        description: {{`The node exporter '{{ $labels.job }}' is down.`}}
        summary: {{`'NODE EXPORTER SERVICE CRITICAL: NODE ''{{ $labels.host }}'''`}}
    - alert: node_running_out_of_disk_space_WARNING
      expr: sum by(nodename) (((node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_free_bytes{mountpoint="/"}) * 100 / node_filesystem_size_bytes{mountpoint="/"} * on(instance) group_left(nodename) node_uname_info) >= {{ .Values.node_disk_usage_percentage_threshold_Warning }} and ((node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_free_bytes{mountpoint="/"}) * 100 / node_filesystem_size_bytes{mountpoint="/"} * on(instance) group_left(nodename) node_uname_info) < {{ .Values.node_disk_usage_percentage_threshold_Critical }} )
      for: 1m
      labels:
        severity: WARNING
      annotations:
        description: {{`'Disk usage is {{ humanize $value }}%'`}}
        summary: {{`'LOW DISK SPACE WARING: NODE {{ $labels.nodename }}'`}}
    - alert: node_running_out_of_disk_space_WARNING
      expr: sum by(nodename) (((node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_free_bytes{mountpoint="/"}) * 100 / node_filesystem_size_bytes{mountpoint="/"} * on(instance) group_left(nodename) node_uname_info) >= {{ .Values.node_disk_usage_percentage_threshold_Critical }} and ((node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_free_bytes{mountpoint="/"}) * 100 / node_filesystem_size_bytes{mountpoint="/"} * on(instance) group_left(nodename) node_uname_info) < {{ .Values.node_disk_usage_percentage_threshold_Fatal }} )
      for: 1m
      labels:
        severity: CRITICAL
      annotations:
        description: {{`'Disk usage is {{ humanize $value }}%'`}}
        summary: {{`'LOW DISK SPACE WARING: NODE {{ $labels.nodename }}'`}}
    - alert: node_running_out_of_disk_space_FATAL
      expr: sum by(nodename) ((node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_free_bytes{mountpoint="/"}) * 100 / node_filesystem_size_bytes{mountpoint="/"} * on(instance) group_left(nodename) node_uname_info) >= {{ .Values.node_disk_usage_percentage_threshold_Fatal }}
      for: 1m
      labels:
        severity: FATAL
      annotations:
        description: {{`'Disk usage is {{ humanize $value }}%'`}}
        summary: {{`'LOW DISK SPACE WARING: NODE {{ $labels.nodename }}'`}}
