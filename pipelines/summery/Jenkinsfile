node(){
 cleanWS()

           values = [:]
           def upstream = currentBuild.rawBuild.getCause(hudson.model.Cause$UpstreamCause)
           triggerCause = upstream?.shortDescription
           if (triggerCause != null)
            triggerCause = triggerCause.split()[4].replaceAll('"', '')
           values.put('copy_metadata_from', triggerCause)
       


       envDir = values.copy_metadata_from.split('/')[-3].trim()
       module = values.copy_metadata_from.split('/')[-2].trim()
       jobName = values.copy_metadata_from.split('/')[-1].trim()      
     
       copyArtifacts projectName: values.copy_metadata_from, fingerprintArtifacts: true, flatten: true, selector: specific(params.build_number), filter: metadata.json
  
    if (module == "Core"){
          image_name = sh(returnStdout: true, script: 'jq -r .image_name metadata.json').trim()
          image_tag = sh(returnStdout: true, script: 'jq -r .image_tag metadata.json').trim()
      } 
      else
                   
         artifact_version = sh(returnStdout: true, script: 'jq -r .artifact_version metadata.json').trim() 

          
       pipelineParams.put('envDir', env)
       pipelineParams.put('module', module)
       pipelineParams.put('jobName', jobName)
       pipelineParams.put('artifact_version', artifact_version)
       pipelineParams.put('image_name', image_name)
       pipelineParams.put('image_tag', image_tag)    
   
   if (pipelineParams.image_tag == null){
                       sh """
                              mkdir -p $JENKINS_HOME/summary/${pipelineParams.env}
                              touch -a $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                              sed -i "s/${pipelineParams.jobName}.*//g" $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                              sed -i "/^$/d" $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                              echo "${pipelineParams.jobName} : ${pipelineParams.artifact_version}" >> $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                          """
                       }
                       if (pipelineParams.image_tag != null){
                       sh """
                              mkdir -p $JENKINS_HOME/summary/${pipelineParams.env}
                              touch -a $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                              sed -i "s/${pipelineParams.image_name}.*//g" $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                              sed -i "/^$/d" $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                              echo "${pipelineParams.image_name} : ${pipelineParams.image_tag}" >>   $JENKINS_HOME/summary/${pipelineParams.env}/summary.txt
                          """
              }
}
